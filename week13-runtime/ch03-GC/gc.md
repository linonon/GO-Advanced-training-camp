# GC

## Garbage Collection

### 主流回收算法

- 引用計數
- 追蹤式垃圾回收（GO， java）

## Mark Sweep

### STW

stop the world，需要停止所有 mutator 來確定引用關係

### Root

不需要其他對象就可以直接訪問的對象。比如全局對象，Stack對象的數據等，可以通過 Root對象追蹤到其他存活的對象。

## Tri-color Mark & Sweep

初始將所有內存標記為`白色`，然後將 roots 加入待掃描隊列（進入隊列機被視為`灰色`），然後使用高併發 goroutine 掃描隊列中的指針，如果指針還引用了其他指針，那麼被引用的也進入隊列`灰色`，被掃瞄的對象視為`黑色`。

- 白色： 潛在的垃圾，其內存可能會被垃圾收集器回收
- 黑色：活躍的對象，垃圾回收器`不會掃描`這些對象的`子對象`
- 灰色：活躍的對象，垃圾回收器`會掃描`這些對象的`子對象`

## Tri-color Marking

垃圾收集器從 root 開始，然後跟隨指針遞歸整個內存空間。分配與 noscan 的 span 的對象，不會進行掃描。然而，此過程不是由同一個 goroutine 完成的，每個指針抖排隊在工作池中，先看到的標記為工作攜程，後台攜程從該池中出隊，掃描對象，然後將其中找到的指針排入隊列。

### 強三色不變性

黑色對象不會指向白色對象，只會指向灰色對象或者黑色對象。

### 弱三色不變性

黑色對象指向的白色對象必須包含一條從灰色對象經由多個白色對象的可達路徑（如果黑色指向了一個白色，那表明這個白色肯定會被另一段帶灰色的路指向。

TODO: 可以重新看看 GC 原理.
