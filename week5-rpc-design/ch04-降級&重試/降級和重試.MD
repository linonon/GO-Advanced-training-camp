# 降級 與 重試

## 降級

自動降級需要考慮的幾個點：

- 確定具體採用哪個`指標`作為流量評估和優雅降級的`決定性指標`（如，CPU，延遲，隊列長度，線程數量，錯誤等）。
- 當服務進入降級模式時，需要執行什麼動作。
- 應該在哪一層實現

同時需要考慮一下幾點：

- 降級不應該經常觸發，通常出發條件是容量規劃的失誤，或者是意外的負載。
- 演練：代碼平常不會觸發和使用，需要定期針對一小部分的流量進行演練，保證模式的正常。
- 降級本身應該足夠簡單。

- 降級本質：提供有損服務
  - UI模塊化，非核心模塊降級。
    - BFF層聚合API，模塊降級。
  - 頁面上一次緩存副本。
  - 默認值，熱門推薦等。
  - 流量攔截 + 定期數據緩存（過期副本策略）。
- 處理策略：
  - 頁面降級、延遲服務、寫/讀降級、緩存降級
  - 拋異常、返回約定協議、Mock數據、Fallback處理。

## 重試

當請求返回錯誤（例：配額不足、超時、內部錯誤等），對於 backend 部分節點過載等情況下，傾向於立刻重試，但是需要留意重試帶來的`流量放大`。

- 限制重試次數和基於重試分佈的策略（重試比率：10%）
- 如移動端連接失敗的重連：隨即化、指數型遞增的重試週期等。
- Client端記錄重試次數直方圖，傳遞到server，進行分佈判定，並交由server判定拒絕。
- 只應該在失敗的層進行重試，當重試仍然失敗，全局約定錯誤碼“過載，無需重試”，避免指數重試。（如下圖）
![](/week5-rpc-design/pic/服務請求流程.png)
