# IM 私信系統

## 服務類型

主要服務可以分為三大類

1. 無狀態服務：登陸，註冊，用戶信息等，可以用`HTTP API`方式
2. 有狀態服務：消息、群聊、用戶狀態，可以通過`實時通信`的方式
3. 第三方服務：APNs、小米、華為等

## 模塊功能

在聊天系統中，Goim 主要角色是 Real time service，實現對 連接 和 狀態的管理。

可以通過 API servers 進行系統之間的解耦

- 各個服務的主要功能為：
  - 聊天服務，進行消息的 `發送` 和 `接受`
  - 在線狀態服務，管理用戶 `在線` 和 `離線`
  - API 服務處理， `用戶登錄、註冊、修改信息`
  - 通知服務器，發送推送通知
  - 存儲服務，通過 `KV` 進行存儲，查詢聊天信息

## 消息發送流程

一對一聊天，主要的消息發送流程：

- A 向 `聊天服務` 發送信息給 B
- `聊天服務` 從 `生成器` 獲取 `消息ID`
- `聊天服務` 將消息發送到 `消息隊列`
- 消息保存在 `KV` 存儲中
- 如果用戶在線，則轉發消息給用戶
- 如果用戶不在線，則轉發到 `通知服務`

## 發信箱 / 收信箱

- 收信箱：該用戶收到的消息
- 發信箱：該用戶發出的消息

- TimeLine模型：
  - 每個消息擁有一個唯一的順序ID（Sequencel ID），消息按 Sequence ID 排序。
  - 新消息寫入能自動分配遞增的順序 ID，保證永遠插入隊尾。
  - 支持根據順序 ID 的隨機定位，可根據 Sequencel ID 隨機定位到 Timeline 中的某個位置。

## 存儲類型選擇

- 關係型：用於存儲用戶信息，好友列表，群組信息等，通過主從、分片基本滿足。
- KV存儲：消息存儲（私聊）這類單一的，有3個好處:
  1. 水平擴展
  2. 延遲低
  3. 訪問成本低

## 消息存儲設計（1 on 1）

- 消息數據類型：
  - message_id，消息ID
  - message_from，消息發送者ID
  - message_to，消息接受者ID
  - content，消息內容
  - created_at，消息發送時間

- 收件發件箱設計：
  - 收件箱：`<message_to>_<message_id>:<outbox_message_key>`
  - 發件箱：`<message_from>_<message_id>:<message>`

## 消息存儲設計（Group chat）

- 消息數據模型：
  - channel_id
  - message_id
  - user_id
  - content
  - create_at

- 收件箱發件箱設計：
  - 收件箱，KV：
    - 讀擴散：`<channel_id>_<message_id> : <outbox_message_key>`
    - 寫擴散：`<user_id>_<message_id> : <outbox_message_key>`
  - 發件箱，KV：
    - `<user_id>_<message_id> : <message>`

- 單件箱（多寫），每個用戶都保存一份信息：
  - 消息同步流程比較簡單，每個客戶端僅需要讀取自己的信箱，即可獲取新消息。
  - 當群組成員數量比較小時，成本也不是很高
  - 對群的數量沒有要求
- 多件箱（多讀），每個群僅保存一份消息：
  - 用戶需要同時查詢多個信箱
  - 如果信箱比較多，查詢成本則比較高
  - 需要控制群組上限

## 推拉結合模式

在長連接中，如果想把消息通知所有人，主要有兩種模式：一種是自己拿廣播通知所有人（推），一種是有人主動來找你要（拉）。

- 在 IM 系統中的三種可能的做法：
  - 推：有新消息時，服務器主動推給所有端（iOS，Android，PC等）
  - 拉：由前端主動發起拉消息的請求，為了保證消息的實時性，一般採用推模式，拉主要一本用於獲取歷史消息。
  - 推拉結合：有新消息時，服務器會先推一個有`新消息的通知`給前端，前端收到通知後再向服務器拉去消息。
